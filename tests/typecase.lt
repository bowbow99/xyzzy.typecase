;;; -*- mode: lisp; package: test.typecase -*-
;;;
;;; tests/typecase.lt
;;;

;;; Code:

(require "typecase")
(require "lisp-unit")

(defpackage :test.typecase
  (:use :lisp :lisp-unit))

(in-package :test.typecase)

(remove-all-tests :test.typecase)

(deftype callable ()
  `(or function
       (and symbol (satisfies fboundp))))


(define-test typecase
  (dolist (x '(("foo" . :string)
               (foo   . :symbol)
               (:foo  . :symbol)
               (123   . :fixnum)
               (#\c   . :other)
               ((t nil) . :other)))
    (assert-eql (cdr x)
        (typecase (car x)
          (string :string)
          (fixnum :fixnum)
          (symbol :symbol)
          (t      :other))
      (car x) (cdr x))
    (assert-eql (cdr x)
        (typecase (car x)
          (string :string)
          (fixnum :fixnum)
          (symbol :symbol)
          (otherwise :other))
      (car x) (cdr x)))
  ;; Use typespec defined via `deftype`
  (dolist (x `((car   . :callable)
               (,#'car . :callable)
               ("foo" . :other)
               (x     . :other)))
    (assert-eql (cdr x)
        (typecase (car x)
          (callable  :callable)
          (otherwise :other))
      (car x)
      (cdr x))))

(define-test etypecase
  (macrolet ((do-etypecase (x)
               `(etypecase ,x
                  (callable :callable)
                  (symbol :symbol)
                  (string :string)
                  (fixnum :fixnum))))
    (dolist (x (list #'car 'car 'foo "foo" 33))
      (assert-true (do-etypecase x)))
    (dolist (x (list '(t . nil) #(a b c) (make-hash-table)))
      (assert-error 'type-error
          (do-etypecase x)))))

;;; tests/typecase.lt ends here.
